{% extends "launchpad/layout.html" %} 
{% load rest_framework %}
{% load static %}{% load i18n %}
{% block content %}
<!-- Bootstrap core CSS -->
<link href="{% static "jetway/leafletjs/leaflet.css" %}" rel="stylesheet">    


<div>
<h2>{{ flightoperation.name }}</h2>
<table  class="table">
    <thead>
        <tr>
            <th></th>
            <th></th>
        </tr>
    </thead>
    <tr>
        <td>Operator </td>
        <td><a href="/launchpad/operators/{{ flightoperation.operator.id}}/detail">{{ flightoperation.operator.company_name }}</a></td>
    </tr>
    <tr>
        <td>Drone </td>
        <td><a href="/launchpad/aircrafts/{{ flightoperation.drone.id}}/detail">{{ flightoperation.drone.model }}</a></td>
    </tr>
    <tr>
        <td>Flight Path / Area</td>
        <td><div id="flight_plan" class="map"></div></td>    
    </tr>
    <tr>
        <td>Type of Operation</td>
        <td>{{ flightoperation.get_type_of_operation_display}}</td>
    </tr>
    </tr>
    <tr>
        <td>Purpose</td>
        <td>{{ flightoperation.purpose}}</td>
    </tr>
    <tr>
        <td>Pilot</td>
        <td><a href="/launchpad/people/{{ flightoperation.pilot.person.id}}/detail">{{ flightoperation.pilot.person.first_name}} {{ flightoperation.pilot.person.last_name}}</a></td>
    </tr>
    </tr>
    <tr>
        <td>Operation Start</td>
        <td><p class="text-muted">{{ flightoperation.start_datetime }}</p></td>
    </tr>
    <tr>
        <td>Opearation End</td>
        <td><p class="text-muted">{{ flightoperation.end_datetime }}</p></td>
    </tr>

</table>
<br>
{% if flightoperation.is_editable %}
    <p><a class="btn btn-primary" href="/launchpad/flightoperations/{{flightoperation.id}}"><b>Update Details</b></a>&nbsp;&nbsp;{% if not flightpermission %}<a class="btn btn-primary" href="/launchpad/flightoperations/{{flightoperation.id}}/permission"><b>Issue Flight Permission</b></a>{% else %}<a class="btn btn-secondary" href="/launchpad/flightpermissions/{{flightpermission.id}}/detail"><b>See Flight Permission</b></a>{% endif %}</p>
{% else %}    
    <p class='text-muted'>This flight operation had a log associated with it that has been signed and cannot be edited, create a new plan, and a new operation .</p>
{% endif %}


</div>

<script src="{% static "jetway/leafletjs/leaflet.js" %}"  type="text/javascript"></script>
<script src="{% static "jetway/leafletjs/L.KML.js" %}" type="text/javascript"></script>
<script type="text/javascript">
    var map = L.map('flight_plan', {zoomControl: false,   doubleClickZoom: false, 
        closePopupOnClick: false, 
        dragging: false, 
        trackResize: false,
        touchZoom: false,
        scrollWheelZoom: false});
        
    
    
    let raw_kml = '{{ flightoperation.flight_plan.kml|safe }}';
        // Create new kml overlay
        const parser = new DOMParser();
        const kml = parser.parseFromString(raw_kml, 'text/xml');
        const track = new L.KML(kml);
        map.addLayer(track);
        map.fitBounds(track.getBounds());
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
</script>

{% endblock %}